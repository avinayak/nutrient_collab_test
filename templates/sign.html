<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sign Document</title>
    <script src="https://cdn.cloud.pspdfkit.com/pspdfkit-web@1.9.1/nutrient-viewer.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      #doc-container {
        width: 100%;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="doc-container"></div>

    <script>
      const documentId = "{{ doc_id }}";
      const jwtToken = "{{ token }}";
      const engineUrl = "{{ engine_url }}";

      // Initialize the Nutrient Viewer
      PSPDFKit.load({
        container: "#doc-container",
        documentId: documentId,
        authPayload: { jwt: jwtToken },
        serverUrl: engineUrl,
        instant: true, // Enable Instant sync
      })
        .then(async (instance) => {
          console.log("Nutrient Viewer loaded", instance);
          const fieldValidValues = {};
          const formFields = await instance.getFormFields();
          const numericOnlyFields = formFields
            .toArray()
            .filter((field) => field.name.startsWith("NUMERIC"))
            .map((field) => field.name);

          instance.addEventListener("formFieldValues.update", (formFields) => {
            formFields.forEach((formField) => {
              if (numericOnlyFields.includes(formField.name)) {
                const currentValues = instance.getFormFieldValues();
                const newValue = currentValues[formField.name] || "";
                if (/^\d*$/.test(newValue)) {
                  fieldValidValues[formField.name] = newValue;
                } else {
                  instance.setFormFieldValues({
                    [formField.name]: fieldValidValues[formField.name] || "",
                  });
                }
              }
            });
          });

          return instance;
        })
        .catch((error) => {
          console.error("Failed to load PDF", error);
          document.body.innerHTML = `<h3>Error loading document: ${error.message}</h3>`;
        });
    </script>
  </body>
</html>
